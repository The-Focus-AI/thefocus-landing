#!/bin/bash
#MISE description="Build all subsites defined in subsites.toml"

set -e

name="" path="" astro_dir="" base="" output=""

build_current() {
    [[ -z "$path" ]] && return

    local site_path="$path"
    [[ "$astro_dir" != "." ]] && site_path="$site_path/$astro_dir"

    echo "Building: $name ($site_path)"
    cd "$site_path"
    mise trust
    mise run build-site "$base" "$(pwd)/../../public/$output"
    cd - > /dev/null
}

while IFS= read -r line; do
    line="${line#"${line%%[![:space:]]*}"}"
    [[ -z "$line" || "$line" == \#* ]] && continue

    if [[ "$line" == "[[subsites]]" ]]; then
        build_current
        name="" path="" astro_dir="" base="" output=""
    elif [[ "$line" =~ ^([a-z_]+)[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
        declare "${BASH_REMATCH[1]}=${BASH_REMATCH[2]}"
    fi
done < subsites.toml

build_current
