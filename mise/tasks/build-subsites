#!/bin/bash
#MISE description="Build all subsites defined in subsites.toml"

set -e

ROOT="$(pwd)"
name="" workdir="" output="" build=""

build_current() {
    [[ -z "$workdir" ]] && return

    echo "Building: $name"
    cd "$ROOT/$workdir"
    mise trust
    eval "$build"
    cd "$ROOT"
}

while IFS= read -r line; do
    line="${line#"${line%%[![:space:]]*}"}"
    [[ -z "$line" || "$line" == \#* ]] && continue

    if [[ "$line" == "[[subsites]]" ]]; then
        build_current
        name="" workdir="" output="" build=""
    elif [[ "$line" =~ ^([a-z_]+)[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
        declare "${BASH_REMATCH[1]}=${BASH_REMATCH[2]}"
    fi
done < subsites.toml

build_current
