---
import { getCaseStudies, getCaseStudyUrl } from "../../utils/case-studies";
import BaseLayout from "../../layout/BaseLayout.astro";
import { render } from "astro:content";
import type { CollectionEntry } from "astro:content";
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const case_studies = await getCaseStudies();
  return case_studies.map((entry) => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const case_study = entry as CollectionEntry<"case_studies">;
const { Content } = await render(entry);

// Get related case studies
const all_case_studies = await getCaseStudies();
const related = all_case_studies.filter((cs) => cs.id !== case_study.id).slice(0, 2);

// Load hero image
const images = await import.meta.glob<{ default: ImageMetadata }>('/src/content/assets/case-studies/*.{jpeg,jpg,png,gif}');
const img_key = `/src/content/assets/case-studies/${case_study.data.image}`;
const heroImage = images[img_key];

// Check for video version (e.g., distill_wide.png -> distill_wide_loop.mp4)
const videoName = case_study.data.image?.replace(/\.(png|jpg|jpeg|gif)$/, '_loop.mp4');
const videoPath = videoName ? `/videos/case-studies/${videoName}` : null;

// Parse results into array
function parseResults(results: string) {
  if (!results) return [];
  const lines = results.split('\n').filter(line => line.trim().startsWith('-'));
  return lines.map(line => line.replace(/^-\s*/, '').trim());
}

const results = parseResults(case_study.data.results);
---

<BaseLayout
  pageTitle={case_study.data.title}
  description={case_study.data.description}
  category="case-studies"
>
  <article class="max-w-4xl mx-auto">
    <!-- Header -->
    <header class="mb-12">
      <div class="flex items-center gap-4 mb-6">
        <span class="text-sm uppercase tracking-widest text-graphite">{case_study.data.industry}</span>
        {case_study.data.timeline && (
          <span class="text-sm bg-tint-warm px-3 py-1 rounded">{case_study.data.timeline}</span>
        )}
      </div>

      <h1 class="font-sans text-4xl md:text-5xl font-bold text-ink mb-6 leading-tight">
        {case_study.data.title}
      </h1>

      <p class="text-xl text-graphite mb-8">
        {case_study.data.description}
      </p>

      <!-- Meta row -->
      <div class="flex flex-wrap gap-x-8 gap-y-2 text-sm border-y border-gray-200 py-4">
        <div>
          <span class="text-graphite">Client:</span>
          <span class="font-medium text-ink ml-1">{case_study.data.client}</span>
        </div>
        <div>
          <span class="text-graphite">Year:</span>
          <span class="font-medium text-ink ml-1">{case_study.data.year}</span>
        </div>
        {case_study.data.services && (
          <div>
            <span class="text-graphite">Services:</span>
            <span class="font-medium text-ink ml-1">{case_study.data.services}</span>
          </div>
        )}
        {case_study.data.tech_stack && (
          <div class="hidden md:block">
            <span class="text-graphite">Stack:</span>
            <span class="font-medium text-ink ml-1">{case_study.data.tech_stack}</span>
          </div>
        )}
      </div>
    </header>

    <!-- Hero Image/Video -->
    {(heroImage || videoPath) && (
      <div class="relative aspect-[2/1] mb-12 overflow-hidden bg-tint-cool">
        {videoPath ? (
          <video
            autoplay
            loop
            muted
            playsinline
            poster={heroImage ? heroImage().src : undefined}
            class="absolute inset-0 w-full h-full object-cover"
          >
            <source src={videoPath} type="video/mp4" />
          </video>
        ) : heroImage && (
          <Image
            src={heroImage()}
            alt={case_study.data.title}
            class="absolute inset-0 w-full h-full object-cover"
            width={1200}
          />
        )}
      </div>
    )}

    <!-- Results highlight -->
    {results.length > 0 && (
      <div class="bg-ink text-paper p-8 md:p-10 mb-12 -mx-4 md:mx-0 md:rounded-lg">
        <h2 class="font-sans text-sm uppercase tracking-widest text-paper/60 mb-4">Key Results</h2>
        <div class="grid md:grid-cols-2 gap-4">
          {results.map((result) => (
            <div class="flex items-start gap-3">
              <span class="text-petrol text-xl leading-none">âœ“</span>
              <span class="text-lg">{result}</span>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Main Content -->
    <div class="prose prose-lg max-w-none
      prose-headings:font-sans prose-headings:text-ink prose-headings:font-bold
      prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6
      prose-h3:text-2xl prose-h3:mt-10 prose-h3:mb-4
      prose-h4:text-xl prose-h4:mt-8 prose-h4:mb-3
      prose-p:text-graphite prose-p:leading-relaxed
      prose-a:text-petrol prose-a:no-underline hover:prose-a:underline
      prose-strong:text-ink
      prose-code:bg-tint-cool prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm
      prose-pre:bg-ink prose-pre:text-paper
      prose-li:text-graphite
      prose-table:text-sm
      prose-th:text-left prose-th:text-ink prose-th:font-bold prose-th:border-b prose-th:border-gray-300 prose-th:pb-2
      prose-td:border-b prose-td:border-gray-200 prose-td:py-3
    ">
      <Content />
    </div>

    <!-- Testimonial -->
    {case_study.data.testimonial && (
      <aside class="mt-16 border-l-4 border-petrol pl-8 py-4">
        <blockquote class="text-xl md:text-2xl text-ink italic mb-4 leading-relaxed">
          "{case_study.data.testimonial}"
        </blockquote>
        <div>
          <p class="font-bold text-ink">{case_study.data.testimonial_person}</p>
          <p class="text-sm text-graphite">{case_study.data.testimonial_company}</p>
        </div>
      </aside>
    )}

    <!-- CTA -->
    <div class="mt-16 pt-12 border-t border-gray-200">
      <div class="bg-tint-cool p-8 md:p-12 rounded-lg">
        <h2 class="font-sans text-2xl font-bold text-ink mb-4">
          Facing a similar challenge?
        </h2>
        <p class="text-graphite mb-6">
          Let's talk about how we can help you move from idea to production.
        </p>
        <a
          href="mailto:hey@thefocus.ai"
          class="inline-block px-8 py-4 bg-ink text-paper font-medium uppercase text-sm tracking-wider hover:bg-petrol transition-colors"
        >
          Start a Conversation
        </a>
      </div>
    </div>

    <!-- Related Case Studies -->
    {related.length > 0 && (
      <nav class="mt-16 pt-12 border-t border-gray-200">
        <h2 class="font-sans text-2xl font-bold text-ink mb-8">More Case Studies</h2>
        <div class="grid md:grid-cols-2 gap-8">
          {related.map((cs) => (
            <a href={getCaseStudyUrl(cs)} class="group block">
              <span class="text-xs uppercase tracking-widest text-graphite">{cs.data.industry}</span>
              <h3 class="font-sans text-xl font-bold text-ink group-hover:text-petrol transition-colors mt-1 mb-2">
                {cs.data.title}
              </h3>
              <p class="text-graphite line-clamp-2">{cs.data.description}</p>
            </a>
          ))}
        </div>
      </nav>
    )}
  </article>
</BaseLayout>
